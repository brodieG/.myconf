# Base Build

## Scratch

Recent configure/builds I've been doing:

    make distclean && ./configure --with-valgrind-instrumentation=2
    make distclean && ./configure --with-recommended-packages=no

    make distclean && ./configure --with-valgrind-instrumentation=2 --with-recommended-packages=no

## Best practices

## Sanitized Build

### gcc

We've been able to build sanitized in clang, but not in gcc because the
undefined behavior sanitizer doesn't seem to work.

See todo in `misc` repo.

### clang

config.site config:

    ## CC="clang -fsanitize=address,undefined -fno-sanitize=float-divide-by-zero -fno-sanitize=alignment -fno-omit-frame-pointer"
    ## CXX="clang++ -fsanitize=address,undefined -fno-sanitize=float-divide-by-zero -fno-sanitize=alignment -fno-omit-frame-pointer -frtti"
    ## CFLAGS="-g -O3 -Wall -pedantic"
    ## FFLAGS="-g -O2 -mtune=native"
    ## CXXFLAGS="-g -O3 -Wall -pedantic"
    ## MAIN_LD="clang++ -fsanitize=undefined,address"

## Setup

    svn checkout https://svn.r-project.org/R/trunk/ trunk
    svn cleanup --remove-unversioned
    ./tools/rsync-recommended
    ./configure                # with options
    make

## Using `rchk` Vagrant Image

So it turns out the `rchk` image is a pretty good starting point for building
our own R packages, so from within, we can do, for example:

```
sudo apt-get install valgrind
cd ~/trunk
./configure --with-valgrind-instrumentation=2
make
./bin/R -d "valgrind --track-origins=yes"
```

> Make sure ~/.R/Makevars has -O0 setting (for packages only, see configuration)

## Other Useful Flags / Settings

`--disable-byte-compiled-packages` makes install a little faster, and also
changes some behavior (used by Maechler?).

More on the CRAN site:

* [Check Configurations][2], in particular:
* [Valgrind config][1]

## Required packages:

### pcre2

```
apt-cache search pcre2               # see what's available
sudo apt-get install libpcre2-8-0    # this alone isn't enough
sudo apt-get install libpcre2-dev    # this did it
```

## Configuration

> Note: docs recommend running `make clean` or `make distclean` after each
> configuration. 

In `config.site` (looks like `make clean` or `make distclean` required to get
changes to register), otherwise need to use envvars.

    CC="gcc-10"
    CFLAGS="-g -O2 -Wall -Wpedantic -std=gnu99" 

Or

    CC="clang-10"
    CFLAGS="-g -O2 -Wall -Wpedantic -std=gnu99" 

Or to actually get macro expansion in `gdb`

    CFLAGS="-gdwarf -g3 -O0 -Wall -Wpedantic -std=gnu99" 

These should then show up on compilation.

Also putting them in `~/.R/Makevars` does not seem to work (packages only?
r-inst not clear about this).  Edit: there is `Makevars` file in the top level
that might be generated by `configure`, and also one in `etc/Makevars`
apparently.

Maechler uses:
* `R_NO_BASE_COMPILE=true` (or --disable-byte-compiled-packages)

## Checking

```
make check | tee check.out
make check-devel
make check-all
```

## Adding Features

### Overview

A few things I added that I no longer remember how to do:

* GDB?
* Updated the perl engine.

### Compilers

```
sudo add-apt-repository ppa:ubuntu-toolchain-r/test
```

[1]: https://www.stats.ox.ac.uk/pub/bdr/memtests/README.txt
[2]: https://cran.r-project.org/web/checks/check_issue_kinds.html
[3]: https://lemire.me/blog/2016/04/20/no-more-leaks-with-sanitize-flags-in-gcc-and-clang/
