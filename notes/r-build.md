# Build

## Recommended build

We've found we really want to build things out-of-tree, ultimately succumbing to
good advice because of vagrant issues with in theory blocking system calls (e.g.
mv) on shared folders.  So set-up the following in e.g. /etc/environment:

    RBUILD="~/r-build"
    RSRC="/vagrant/trunk"

After restarting the shell, download the sources

    svn checkout https://svn.r-project.org/R/trunk/ $RSRC
    cd $RSRC
    svn cleanup --remove-unversioned
    ./tools/rsync-recommended   # optional

Then configure from the build directory:

    cd $RBUILD
    $RSRC/configure

Or

    cd $RBUILD && $RSRC/configure --with-recommended-packages=no

We've found that building of tree allows us to work around problems with vagrant
and shared folders (we observed `mv` behave in a non-blocking way there starting
in early 2022 breaking reg-packages.R).  So now we build in a separate build
directory.

Or better:

    cd $RBUILD
    make distclean && $RSRC/configure --with-recommended-packages=no

To build the parser gram / bison files:

    cd $RBUILD
    make distclean && $RSRC/configure --enable-maintainer-mode --with-recommended-packages=no

For bison we might require installing `noweb` to get past the `compiler` rebuild:

    sudo apt-get noweb

## Other Useful Flags / Settings

Maechler uses:
* `R_NO_BASE_COMPILE=true` (or --disable-byte-compiled-packages)

More on the CRAN site:

* [Check Configurations][2], in particular:
* [Valgrind config][1]

## Configuration

> Note: docs recommend running `make clean` or `make distclean` after each
> configuration. 

In `config.site` (looks like `make clean` or `make distclean` required to get
changes to register), otherwise need to use envvars.

    CC="gcc-10"
    CFLAGS="-g -O2 -Wall -Wextra -pedantic -std=gnu99" 

Or (note pedantic flag different)

    CC="clang-10"
    CFLAGS="-g -O2 -Wall -Wpedantic -std=gnu99" 

Or to actually get macro expansion in `gdb`

    CFLAGS="-gdwarf -g3 -O0 -Wall -Wpedantic -std=gnu99" 

These should then show up on compilation.

Also putting them in `~/.R/Makevars` does not seem to work (packages only?
r-inst not clear about this).  Edit: there is `Makevars` file in the top level
that might be generated by `configure`, and also one in `etc/Makevars`
apparently.

## Required packages:

### pcre2

```
apt-cache search pcre2               # see what's available
sudo apt-get install libpcre2-8-0    # this alone isn't enough
sudo apt-get install libpcre2-dev    # this did it
```

### Compilers

For later versions of gcc/clang:

```
sudo add-apt-repository ppa:ubuntu-toolchain-r/test
```
# Checking

## Tests

```
make check | tee check.out
make check-devel
make check-all
```
## Compile Checks

### gcc - sanitized

We've been able to build sanitized in clang, but not in gcc because the
undefined behavior sanitizer doesn't seem to work.

See todo in `misc` repo.

### clang - sanitized

config.site config:

    CC="clang -fsanitize=address,undefined -fno-sanitize=float-divide-by-zero -fno-sanitize=alignment -fno-omit-frame-pointer"
    CXX="clang++ -fsanitize=address,undefined -fno-sanitize=float-divide-by-zero -fno-sanitize=alignment -fno-omit-frame-pointer -frtti"
    CFLAGS="-g -O3 -Wall -pedantic"
    FFLAGS="-g -O2 -mtune=native"
    CXXFLAGS="-g -O3 -Wall -pedantic"
    MAIN_LD="clang++ -fsanitize=undefined,address"

### Valgrind

See 'valgrind.md'

[1]: https://www.stats.ox.ac.uk/pub/bdr/memtests/README.txt
[2]: https://cran.r-project.org/web/checks/check_issue_kinds.html
[3]: https://lemire.me/blog/2016/04/20/no-more-leaks-with-sanitize-flags-in-gcc-and-clang/
